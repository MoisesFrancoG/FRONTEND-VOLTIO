<div class="container mx-auto px-4 py-6">
  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">
      üìà An√°lisis Estad√≠stico de Datos Energ√©ticos
    </h1>
    <p class="text-gray-600">
      Visualiza las estad√≠sticas hist√≥ricas con an√°lisis probabil√≠sticos
    </p>

    <!-- Informaci√≥n de estado de autenticaci√≥n -->
    <div class="mt-4">
      <div *ngIf="isAuthenticated()" class="flex items-center gap-2 text-sm">
        <span
          class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"
        >
          üîê Autenticado
        </span>
        <span class="text-gray-600">
          Usuario:
          {{
            getCurrentUser().user?.email ||
              getCurrentUser().user?.name ||
              "Usuario"
          }}
        </span>
        <span class="text-gray-500">|</span>
        <span class="text-gray-600"> Datos en tiempo real desde API </span>
      </div>

      <div *ngIf="!isAuthenticated()" class="flex items-center gap-2 text-sm">
        <span
          class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800"
        >
          üîí No autenticado
        </span>
        <span class="text-gray-600">
          Inicia sesi√≥n para acceder a los datos hist√≥ricos.
        </span>
        <button
          (click)="goToLogin()"
          class="ml-2 px-3 py-1 bg-blue-600 text-white text-xs rounded-lg hover:bg-blue-700 transition-colors"
        >
          Iniciar Sesi√≥n
        </button>
      </div>
    </div>
  </div>

  <!-- Controles de selecci√≥n -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Selector de tipo de gr√°fica -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">
        üìä Tipo de An√°lisis
      </h2>

      <div class="grid grid-cols-1 gap-3">
        <button
          *ngFor="let type of graphTypes"
          (click)="onGraphTypeChange(type.value)"
          [class]="
            'p-3 rounded-lg border-2 transition-all duration-200 text-left ' +
            (selectedGraphType === type.value
              ? 'border-green-500 bg-green-50 text-green-700'
              : 'border-gray-200 bg-white text-gray-700 hover:border-green-300 hover:bg-green-50')
          "
        >
          <div class="flex items-center gap-3">
            <span class="text-xl">{{ type.icon }}</span>
            <div>
              <div class="font-semibold text-sm">{{ type.label }}</div>
              <div class="text-xs opacity-75">{{ type.description }}</div>
            </div>
          </div>
        </button>
      </div>
    </div>

    <!-- Selector de variable -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">
        ‚ö° Variable a Analizar
      </h2>

      <div class="grid grid-cols-1 gap-3">
        <button
          *ngFor="let variable of variables"
          (click)="onVariableChange(variable.value)"
          [class]="
            'p-3 rounded-lg border-2 transition-all duration-200 text-left ' +
            (selectedVariable === variable.value
              ? 'border-blue-500 bg-blue-50 text-blue-700'
              : 'border-gray-200 bg-white text-gray-700 hover:border-blue-300 hover:bg-blue-50')
          "
        >
          <div class="font-semibold text-sm">{{ variable.label }}</div>
          <div class="text-xs opacity-75">{{ variable.unit }}</div>
        </button>
      </div>
    </div>

    <!-- Selector de per√≠odo de tiempo -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">
        üïí Per√≠odo de Tiempo
      </h2>

      <div class="grid grid-cols-1 gap-3">
        <button
          *ngFor="let period of periods"
          (click)="onPeriodChange(period.value)"
          [class]="
            'p-3 rounded-lg border-2 transition-all duration-200 text-left ' +
            (selectedPeriod === period.value
              ? 'border-purple-500 bg-purple-50 text-purple-700'
              : 'border-gray-200 bg-white text-gray-700 hover:border-purple-300 hover:bg-purple-50')
          "
        >
          <div class="flex items-center gap-3">
            <span class="text-xl">{{ period.icon }}</span>
            <div>
              <div class="font-semibold text-sm">{{ period.label }}</div>
              <div class="text-xs opacity-75">{{ period.description }}</div>
            </div>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- √Årea principal de la gr√°fica -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h2 class="text-xl font-semibold text-gray-800">
          {{ getGraphTypeInfo().icon }} {{ getGraphTypeInfo().label }} -
          {{ getVariableInfo().label }} ({{ getPeriodInfo().label }})
        </h2>
        <p class="text-sm text-gray-600">
          {{ getGraphTypeInfo().description }} -
          {{ getPeriodInfo().description }}
        </p>
      </div>

      <button
        (click)="refreshData()"
        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 flex items-center gap-2"
        [disabled]="isLoading"
      >
        <span [class]="'inline-block ' + (isLoading ? 'animate-spin' : '')"
          >üîÑ</span
        >
        {{ isLoading ? "Cargando..." : "Actualizar" }}
      </button>
    </div>

    <!-- Contenedor de la gr√°fica -->
    <div class="chart-container">
      <!-- Estado de carga -->
      <div *ngIf="isLoading" class="flex items-center justify-center h-96">
        <div class="text-center">
          <div class="animate-spin text-4xl mb-4">‚è≥</div>
          <p class="text-gray-600">Cargando datos desde la API...</p>
        </div>
      </div>

      <!-- Estado de error -->
      <div
        *ngIf="hasError && !isLoading"
        class="flex items-center justify-center h-96"
      >
        <div class="text-center bg-red-50 p-8 rounded-lg border border-red-200">
          <div class="text-6xl mb-4">‚ö†Ô∏è</div>
          <h3 class="text-xl font-semibold text-red-800 mb-2">
            Error al cargar datos
          </h3>
          <p class="text-red-600 mb-4">{{ errorMessage }}</p>

          <!-- Bot√≥n espec√≠fico para cuando no hay dispositivos PZEM -->
          <div *ngIf="noPzemDevices" class="text-center mt-4">
            <button
              (click)="goToDevices()"
              class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700"
            >
              Registrar Dispositivo PZEM
            </button>
          </div>

          <!-- Si es error de sesi√≥n expirada, mostrar bot√≥n de login -->
          <div *ngIf="errorMessage.includes('sesi√≥n ha expirado')">
            <button
              (click)="goToLogin()"
              class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors mr-2"
            >
              Ir a Login
            </button>
          </div>

          <!-- Para otros errores, mostrar bot√≥n de reintentar -->
          <div *ngIf="!errorMessage.includes('sesi√≥n ha expirado')">
            <button
              (click)="loadData()"
              class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors"
            >
              Reintentar
            </button>
          </div>
        </div>
      </div>

      <!-- Histograma -->
      <div
        *ngIf="
          !isLoading &&
          !hasError &&
          selectedGraphType === 'histogram' &&
          histogramData.length > 0
        "
      >
        <ngx-charts-bar-vertical
          [view]="view"
          [results]="histogramData"
          [gradient]="gradient"
          [xAxis]="showXAxis"
          [yAxis]="showYAxis"
          [legend]="false"
          [showXAxisLabel]="showXAxisLabel"
          [showYAxisLabel]="showYAxisLabel"
          [xAxisLabel]="'Rangos de ' + getVariableInfo().label"
          [yAxisLabel]="yAxisLabel"
          [animations]="animations"
          [scheme]="colorScheme"
        >
        </ngx-charts-bar-vertical>
      </div>

      <!-- Serie Temporal -->
      <div
        *ngIf="
          !isLoading &&
          !hasError &&
          selectedGraphType === 'timeSeries' &&
          timeSeriesData.length > 0
        "
      >
        <ngx-charts-line-chart
          [view]="view"
          [results]="timeSeriesData"
          [gradient]="gradient"
          [xAxis]="showXAxis"
          [yAxis]="showYAxis"
          [legend]="showLegend"
          [showXAxisLabel]="showXAxisLabel"
          [showYAxisLabel]="showYAxisLabel"
          [xAxisLabel]="xAxisLabel"
          [yAxisLabel]="yAxisLabel"
          [animations]="animations"
          [scheme]="colorScheme"
        >
        </ngx-charts-line-chart>
      </div>

      <!-- Boxplot (representado como informaci√≥n estad√≠stica) -->
      <div
        *ngIf="
          !isLoading &&
          !hasError &&
          selectedGraphType === 'boxplot' &&
          boxplotData
        "
      >
        <div class="bg-gray-50 rounded-lg p-6">
          <h3 class="text-lg font-semibold mb-4">
            üìâ An√°lisis de Dispersi√≥n - {{ getVariableInfo().label }}
          </h3>
          <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div class="bg-white p-3 rounded text-center">
              <div class="text-xs text-gray-600">M√≠nimo</div>
              <div class="text-lg font-bold text-blue-600">
                {{ boxplotData.min | number : "1.2-2" }}
              </div>
            </div>
            <div class="bg-white p-3 rounded text-center">
              <div class="text-xs text-gray-600">Q1</div>
              <div class="text-lg font-bold text-green-600">
                {{ boxplotData.q1 | number : "1.2-2" }}
              </div>
            </div>
            <div class="bg-white p-3 rounded text-center">
              <div class="text-xs text-gray-600">Mediana</div>
              <div class="text-lg font-bold text-purple-600">
                {{ boxplotData.median | number : "1.2-2" }}
              </div>
            </div>
            <div class="bg-white p-3 rounded text-center">
              <div class="text-xs text-gray-600">Q3</div>
              <div class="text-lg font-bold text-orange-600">
                {{ boxplotData.q3 | number : "1.2-2" }}
              </div>
            </div>
            <div class="bg-white p-3 rounded text-center">
              <div class="text-xs text-gray-600">M√°ximo</div>
              <div class="text-lg font-bold text-red-600">
                {{ boxplotData.max | number : "1.2-2" }}
              </div>
            </div>
          </div>
          <div
            *ngIf="boxplotData.outliers && boxplotData.outliers.length > 0"
            class="mt-4"
          >
            <div class="text-sm font-semibold text-gray-700">
              üîç Valores At√≠picos (Outliers):
            </div>
            <div class="text-sm text-gray-600">
              {{ boxplotData.outliers.length }} valores detectados
            </div>
          </div>
        </div>
      </div>

      <!-- Barras de Frecuencia -->
      <div
        *ngIf="
          !isLoading &&
          !hasError &&
          selectedGraphType === 'frequencyBars' &&
          frequencyBarsData.length > 0
        "
      >
        <ngx-charts-bar-horizontal
          [view]="view"
          [results]="frequencyBarsData"
          [gradient]="gradient"
          [xAxis]="showXAxis"
          [yAxis]="showYAxis"
          [legend]="false"
          [showXAxisLabel]="showXAxisLabel"
          [showYAxisLabel]="showYAxisLabel"
          [xAxisLabel]="yAxisLabel"
          [yAxisLabel]="'Rangos de ' + getVariableInfo().label"
          [animations]="animations"
          [scheme]="colorScheme"
        >
        </ngx-charts-bar-horizontal>
      </div>

      <!-- Gr√°fico de Pastel -->
      <div
        *ngIf="
          !isLoading &&
          !hasError &&
          selectedGraphType === 'pie' &&
          pieData.length > 0
        "
      >
        <ngx-charts-pie-chart
          [view]="view"
          [results]="pieData"
          [gradient]="gradient"
          [legend]="showLegend"
          [labels]="true"
          [doughnut]="false"
          [animations]="animations"
          [scheme]="colorScheme"
        >
        </ngx-charts-pie-chart>
      </div>

      <!-- Estado sin datos -->
      <div
        *ngIf="!isLoading && rawData.length === 0"
        class="flex items-center justify-center h-96"
      >
        <div class="text-center">
          <div class="text-6xl mb-4">üì≠</div>
          <p class="text-gray-600 text-lg font-semibold">
            No hay datos disponibles
          </p>
          <p class="text-gray-500 text-sm mt-2">
            No se encontraron datos hist√≥ricos para mostrar
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Panel de estad√≠sticas y probabilidades -->
  <div
    class="grid grid-cols-1 lg:grid-cols-2 gap-6"
    *ngIf="!isLoading && statistics"
  >
    <!-- Estad√≠sticas Descriptivas -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">
        üìä Estad√≠sticas Descriptivas
      </h3>

      <div class="grid grid-cols-2 gap-4">
        <div class="bg-blue-50 p-3 rounded-lg">
          <div class="text-blue-800 font-semibold text-sm">Media</div>
          <div class="text-blue-900 text-lg font-bold">
            {{ statistics.mean | number : "1.2-3" }}
            {{ getVariableInfo().unit }}
          </div>
        </div>

        <div class="bg-green-50 p-3 rounded-lg">
          <div class="text-green-800 font-semibold text-sm">Mediana</div>
          <div class="text-green-900 text-lg font-bold">
            {{ statistics.median | number : "1.2-3" }}
            {{ getVariableInfo().unit }}
          </div>
        </div>

        <div class="bg-purple-50 p-3 rounded-lg">
          <div class="text-purple-800 font-semibold text-sm">Moda</div>
          <div class="text-purple-900 text-lg font-bold">
            {{
              statistics.mode
                ? (statistics.mode | number : "1.2-3") +
                  " " +
                  getVariableInfo().unit
                : "N/A"
            }}
          </div>
        </div>

        <div class="bg-orange-50 p-3 rounded-lg">
          <div class="text-orange-800 font-semibold text-sm">
            Desv. Est√°ndar
          </div>
          <div class="text-orange-900 text-lg font-bold">
            {{ statistics.standardDeviation | number : "1.2-3" }}
            {{ getVariableInfo().unit }}
          </div>
        </div>

        <div class="bg-red-50 p-3 rounded-lg">
          <div class="text-red-800 font-semibold text-sm">Rango</div>
          <div class="text-red-900 text-lg font-bold">
            {{ statistics.range | number : "1.2-3" }}
            {{ getVariableInfo().unit }}
          </div>
        </div>

        <div class="bg-gray-50 p-3 rounded-lg">
          <div class="text-gray-800 font-semibold text-sm">Total Registros</div>
          <div class="text-gray-900 text-lg font-bold">
            {{ rawData.length }}
          </div>
        </div>
      </div>
    </div>

    <!-- An√°lisis de Probabilidades Cl√°sicas -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">
        üéØ Probabilidades Cl√°sicas
      </h3>

      <div class="space-y-3">
        <div
          *ngFor="let prob of probabilities | keyvalue"
          class="bg-gray-50 p-3 rounded-lg"
        >
          <div class="text-gray-800 font-semibold text-sm">{{ prob.key }}</div>
          <div class="flex items-center gap-2">
            <div class="text-gray-900 text-lg font-bold">
              {{ prob.value * 100 | number : "1.1-1" }}%
            </div>
            <div class="flex-1 bg-gray-200 rounded-full h-2">
              <div
                class="bg-green-500 h-2 rounded-full transition-all duration-300"
                [style.width.%]="prob.value * 100"
              ></div>
            </div>
          </div>
          <div class="text-xs text-gray-600 mt-1">
            P(A) = {{ prob.value * rawData.length | number : "1.0-0" }} /
            {{ rawData.length }} = {{ prob.value | number : "1.3-3" }}
          </div>
        </div>
      </div>

      <div class="mt-4 p-3 bg-blue-50 rounded-lg">
        <div class="text-blue-800 font-semibold text-sm mb-2">
          üí° Interpretaci√≥n Probabil√≠stica
        </div>
        <div class="text-blue-700 text-xs">
          Las probabilidades se calculan usando la f√≥rmula cl√°sica: P(A) = casos
          favorables / casos posibles. Cada porcentaje representa la frecuencia
          relativa de ocurrencia de ese evento en los datos hist√≥ricos.
        </div>
      </div>
    </div>
  </div>

  <!-- Informaci√≥n adicional -->
  <div
    *ngIf="!isLoading && rawData.length > 0"
    class="mt-6 bg-white rounded-lg shadow-md p-6"
  >
    <h3 class="text-xl font-semibold text-gray-800 mb-4">
      ‚ÑπÔ∏è Informaci√≥n del Dataset
    </h3>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-gray-50 p-3 rounded-lg">
        <div class="text-gray-800 font-semibold text-sm">Per√≠odo</div>
        <div class="text-gray-900 text-sm flex items-center gap-2">
          <span>{{ getPeriodInfo().icon }}</span>
          {{ getPeriodInfo().label }}
        </div>
      </div>

      <div class="bg-gray-50 p-3 rounded-lg">
        <div class="text-gray-800 font-semibold text-sm">Dispositivo</div>
        <div class="text-gray-900 text-sm font-mono">
          {{ rawData.length > 0 ? rawData[0].mac : "N/A" }}
        </div>
      </div>

      <div class="bg-gray-50 p-3 rounded-lg">
        <div class="text-gray-800 font-semibold text-sm">Primer Registro</div>
        <div class="text-gray-900 text-sm">
          {{ rawData.length > 0 ? (rawData[0]._time | date : "short") : "N/A" }}
        </div>
      </div>

      <div class="bg-gray-50 p-3 rounded-lg">
        <div class="text-gray-800 font-semibold text-sm">√öltimo Registro</div>
        <div class="text-gray-900 text-sm">
          {{
            rawData.length > 0
              ? (rawData[rawData.length - 1]._time | date : "short")
              : "N/A"
          }}
        </div>
      </div>
    </div>
  </div>
</div>
