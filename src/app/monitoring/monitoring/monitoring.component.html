<div class="min-h-screen bg-gray-100">
  <!-- Vista de selecci√≥n de dispositivos -->
  <div
    *ngIf="currentView === 'device-selection'"
    class="container mx-auto px-4 py-6"
  >
    <!-- Header -->
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">
        üì° Monitoreo en Tiempo Real
      </h1>
      <p class="text-gray-600">
        Selecciona un dispositivo para visualizar sus datos en tiempo real
      </p>

      <!-- Informaci√≥n de autenticaci√≥n -->
      <div class="mt-4" *ngIf="!isAuthenticated()">
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <div class="flex items-center gap-2">
            <span class="text-yellow-600">‚ö†Ô∏è</span>
            <span class="text-yellow-800 font-semibold">No autenticado</span>
          </div>
          <p class="text-yellow-700 text-sm mt-1">
            Debes iniciar sesi√≥n para ver tus dispositivos.
          </p>
          <button
            (click)="goToLogin()"
            class="mt-2 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors"
          >
            Iniciar Sesi√≥n
          </button>
        </div>
      </div>
    </div>

    <!-- Estado de carga -->
    <div *ngIf="isLoading" class="flex items-center justify-center h-64">
      <div class="text-center">
        <div class="animate-spin text-4xl mb-4">‚è≥</div>
        <p class="text-gray-600">Cargando dispositivos...</p>
      </div>
    </div>

    <!-- Estado de error -->
    <div
      *ngIf="hasError && !isLoading"
      class="flex items-center justify-center h-64"
    >
      <div class="text-center bg-red-50 p-8 rounded-lg border border-red-200">
        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
        <h3 class="text-xl font-semibold text-red-800 mb-2">Error</h3>
        <p class="text-red-600 mb-4">{{ errorMessage }}</p>
        <button
          (click)="loadUserDevices()"
          class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors"
        >
          Reintentar
        </button>
      </div>
    </div>

    <!-- Lista de dispositivos -->
    <div
      *ngIf="!isLoading && !hasError && userDevices.length > 0"
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
    >
      <div
        *ngFor="let device of userDevices"
        class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer"
        (click)="selectDevice(device)"
      >
        <div class="p-6">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-3xl">{{
              getDeviceIcon(device.device_type_id)
            }}</span>
            <div>
              <h3 class="text-lg font-semibold text-gray-800">
                {{ device.name }}
              </h3>
              <p class="text-sm text-gray-600">{{ device.description }}</p>
            </div>
          </div>

          <div class="space-y-2 mb-4">
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Tipo ID:</span>
              <span class="font-medium">{{ device.device_type_id }}</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">MAC:</span>
              <span class="font-mono text-xs">{{ device.mac_address }}</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Registrado:</span>
              <span>{{ device.created_at | date : "short" }}</span>
            </div>
          </div>

          <!-- Variables disponibles -->
          <div class="mb-4">
            <p class="text-xs text-gray-600 mb-2">Variables disponibles:</p>
            <div class="flex flex-wrap gap-1">
              <span
                *ngFor="
                  let variable of getDeviceVariables(device.device_type_id)
                "
                class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded"
              >
                {{ variable }}
              </span>
            </div>
          </div>

          <button
            class="w-full py-2 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium"
          >
            Monitorear en Tiempo Real
          </button>
        </div>
      </div>
    </div>

    <!-- Mensaje cuando no hay dispositivos -->
    <div
      *ngIf="!isLoading && !hasError && userDevices.length === 0"
      class="text-center py-12"
    >
      <div class="text-6xl mb-4">üì±</div>
      <h3 class="text-xl font-semibold text-gray-800 mb-2">
        No hay dispositivos registrados
      </h3>
      <p class="text-gray-600 mb-4">
        Registra tu primer dispositivo para comenzar el monitoreo.
      </p>
      <button
        (click)="router.navigate(['/devices'])"
        class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors"
      >
        Registrar Dispositivo
      </button>
    </div>
  </div>

  <!-- Vista de monitoreo -->
  <div *ngIf="currentView === 'monitoring'" class="flex h-screen">
    <!-- Barra lateral -->
    <aside class="w-80 bg-white shadow-lg p-6 flex flex-col gap-6">
      <!-- Bot√≥n de regreso -->
      <button
        (click)="backToDeviceSelection()"
        class="flex items-center gap-2 text-gray-600 hover:text-gray-800 transition-colors mb-4"
      >
        <span>‚Üê</span>
        <span>Volver a dispositivos</span>
      </button>

      <!-- Informaci√≥n del dispositivo -->
      <div class="bg-gray-50 rounded-lg p-4 border" *ngIf="selectedDevice">
        <div class="flex items-center gap-3 mb-3">
          <span class="text-2xl">{{
            getDeviceIcon(selectedDevice.device_type_id)
          }}</span>
          <div>
            <h3 class="font-semibold text-gray-800">
              {{ selectedDevice.name }}
            </h3>
            <p class="text-xs text-gray-600">
              Tipo ID: {{ selectedDevice.device_type_id }}
            </p>
          </div>
        </div>

        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-600">MAC:</span>
            <span class="font-mono text-xs">{{
              selectedDevice.mac_address
            }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Estado WebSocket:</span>
            <span
              class="px-2 py-1 rounded text-xs"
              [class.bg-green-200]="isWebSocketConnected"
              [class.text-green-700]="isWebSocketConnected"
              [class.bg-red-200]="!isWebSocketConnected"
              [class.text-red-700]="!isWebSocketConnected"
            >
              {{ isWebSocketConnected ? "Conectado" : "Desconectado" }}
            </span>
          </div>
        </div>

        <button
          (click)="reconnectWebSocket()"
          class="w-full mt-3 py-2 px-3 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition"
          [disabled]="isWebSocketConnected"
        >
          {{ isWebSocketConnected ? "Conectado" : "Reconectar" }}
        </button>
      </div>

      <!-- Navegaci√≥n de gr√°ficas -->
      <div class="border-t pt-4" *ngIf="selectedDevice?.device_type_id === 1">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">
          Gr√°ficas Disponibles
        </h3>
        <div class="space-y-2">
          <button
            (click)="setChart('main')"
            [class]="
              selectedChart === 'main'
                ? 'bg-blue-100 border-blue-300 text-blue-700'
                : 'bg-white border-gray-200 text-gray-700 hover:border-blue-300'
            "
            class="w-full py-2 px-3 border rounded text-sm text-left transition"
          >
            üìä Voltaje y Corriente
          </button>
          <button
            (click)="setChart('power')"
            [class]="
              selectedChart === 'power'
                ? 'bg-blue-100 border-blue-300 text-blue-700'
                : 'bg-white border-gray-200 text-gray-700 hover:border-blue-300'
            "
            class="w-full py-2 px-3 border rounded text-sm text-left transition"
          >
            ‚ö° Potencia
          </button>
          <button
            (click)="setChart('energy')"
            [class]="
              selectedChart === 'energy'
                ? 'bg-blue-100 border-blue-300 text-blue-700'
                : 'bg-white border-gray-200 text-gray-700 hover:border-blue-300'
            "
            class="w-full py-2 px-3 border rounded text-sm text-left transition"
          >
            üîã Energ√≠a
          </button>
        </div>
      </div>

      <!-- M√©tricas en tiempo real -->
      <div class="border-t pt-4" *ngIf="selectedDevice && timeData.length > 0">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">
          Valores Actuales
        </h3>
        <div class="space-y-2 text-sm">
          <div
            class="flex justify-between"
            *ngIf="selectedDevice?.device_type_id === 1"
          >
            <span class="text-gray-600">Voltaje:</span>
            <span class="font-mono"
              >{{
                voltageData.length > 0
                  ? (voltageData[voltageData.length - 1] | number : "1.2-2")
                  : "0.00"
              }}
              V</span
            >
          </div>
          <div
            class="flex justify-between"
            *ngIf="selectedDevice?.device_type_id === 1"
          >
            <span class="text-gray-600">Corriente:</span>
            <span class="font-mono"
              >{{
                currentData.length > 0
                  ? (currentData[currentData.length - 1] | number : "1.2-2")
                  : "0.00"
              }}
              A</span
            >
          </div>
          <div
            class="flex justify-between"
            *ngIf="selectedDevice?.device_type_id === 1"
          >
            <span class="text-gray-600">Potencia:</span>
            <span class="font-mono"
              >{{
                powerData.length > 0
                  ? (powerData[powerData.length - 1] | number : "1.2-2")
                  : "0.00"
              }}
              W</span
            >
          </div>
          <div
            class="flex justify-between"
            *ngIf="selectedDevice?.device_type_id === 1"
          >
            <span class="text-gray-600">Energ√≠a:</span>
            <span class="font-mono"
              >{{
                energyData.length > 0
                  ? (energyData[energyData.length - 1] | number : "1.2-2")
                  : "0.00"
              }}
              kWh</span
            >
          </div>
        </div>
      </div>
    </aside>

    <!-- √Årea principal de gr√°ficas -->
    <main class="flex-1 p-6 bg-gray-50">
      <div class="bg-white rounded-lg shadow-lg h-full p-6">
        <!-- Estado de conexi√≥n -->
        <div class="mb-4 flex items-center justify-between">
          <h2 class="text-xl font-semibold text-gray-800">
            Monitoreo en Tiempo Real - {{ selectedDevice?.name }}
          </h2>
          <div class="flex items-center gap-2">
            <div
              class="w-3 h-3 rounded-full"
              [class.bg-green-500]="isWebSocketConnected"
              [class.bg-red-500]="!isWebSocketConnected"
            ></div>
            <span class="text-sm text-gray-600">
              {{ isWebSocketConnected ? "Conectado" : "Desconectado" }}
            </span>
          </div>
        </div>

        <!-- Gr√°fica principal -->
        <div class="h-96" *ngIf="selectedDevice?.device_type_id === 1">
          <!-- Gr√°fica de Voltaje y Corriente -->
          <div *ngIf="selectedChart === 'main'">
            <div echarts [options]="chartOption" class="h-full"></div>
          </div>

          <!-- Gr√°fica de Potencia -->
          <div *ngIf="selectedChart === 'power'">
            <div echarts [options]="powerChartOption" class="h-full"></div>
          </div>

          <!-- Gr√°fica de Energ√≠a -->
          <div *ngIf="selectedChart === 'energy'">
            <div echarts [options]="energyChartOption" class="h-full"></div>
          </div>
        </div>

        <!-- Mensaje para otros tipos de dispositivos -->
        <div
          *ngIf="selectedDevice?.device_type_id !== 1"
          class="h-96 flex items-center justify-center"
        >
          <div class="text-center">
            <div class="text-6xl mb-4">üöß</div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">
              En Desarrollo
            </h3>
            <p class="text-gray-600">
              Las gr√°ficas para dispositivos tipo
              {{ selectedDevice?.device_type_id }} est√°n en desarrollo.
            </p>
          </div>
        </div>

        <!-- Estado sin datos -->
        <div
          *ngIf="!isWebSocketConnected && timeData.length === 0"
          class="h-96 flex items-center justify-center"
        >
          <div class="text-center">
            <div class="text-6xl mb-4">üì°</div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">
              Esperando datos...
            </h3>
            <p class="text-gray-600">
              Conecta el WebSocket para comenzar a recibir datos en tiempo real.
            </p>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>
